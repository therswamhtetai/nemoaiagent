---
phase: 01-daily-briefing-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [".planning/phases/01-daily-briefing-refactor/01-01-SUMMARY.md"]
autonomous: true
must_haves:
  truths:
    - "Can query active users from database efficiently"
    - "Task fetching queries are optimized for user-specific data"
    - "Database performance meets requirements for user iteration"
  artifacts:
    - path: ".planning/phases/01-daily-briefing-refactor/01-01-SUMMARY.md"
      provides: "Database analysis documentation"
      contains: "user query analysis, task optimization"
    - path: "queries/active_users.sql"
      provides: "Optimized user iteration query"
    - path: "queries/user_tasks.sql"
      provides: "User-specific task fetching query"
  key_links:
    - from: "active_users.sql"
      to: "supabase.users"
      via: "database connection"
      pattern: "SELECT.*users.*WHERE is_active"
    - from: "user_tasks.sql"
      to: "supabase.tasks"
      via: "user_id parameter"
      pattern: "SELECT.*tasks.*WHERE user_id"
---

<objective>
Design and optimize database queries for dynamic user iteration in daily briefing workflow.

Purpose: Establish the data foundation for eliminating hardcoded user chains by creating efficient, scalable queries that can handle unlimited users.

Output: Optimized SQL queries, performance benchmarks, and database schema analysis for user iteration.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PHASE_ANALYSIS.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STACK.md

# Current Database Schema (from CLAUDE.md)
users table: id, telegram_id, username, full_name, email, password, language_code, is_active, created_at, updated_at
tasks table: id, user_id, title, description, status, priority, due_date, reminder_sent, created_at, updated_at
user_preferences table: id, user_id, preference_key, preference_value, created_at, updated_at
</context>

<tasks>

<task type="auto">
  <name>Analyze Current Users Table Structure</name>
  <files>.planning/phases/01-daily-briefing-refactor/01-01-SUMMARY.md</files>
  <action>
1. Connect to Supabase using existing credentials (NemoAIDatabase)
2. Analyze users table structure and indexes:
   - DESCRIBE users
   - SHOW INDEX FROM users
   - Count total active vs inactive users
   - Check data distribution patterns
3. Analyze user_preferences table for notification settings:
   - Query existing preference keys
   - Identify notification_channel preferences
   - Check briefing_time preferences
4. Document current query performance:
   - Run SELECT * FROM users WHERE is_active = true
   - Measure execution time with EXPLAIN ANALYZE
   - Test with different user counts (simulate scaling)
5. Create optimized active users query:
   - Include necessary fields for briefing
   - Join with user_preferences for notification settings
   - Add proper indexing recommendations
6. Save query as queries/active_users.sql with performance notes
</action>
  <verify>Run queries/active_users.sql and confirm it returns all active users with their preferences in < 100ms</verify>
  <done>Active users query optimized and documented with performance benchmarks</done>
</task>

<task type="auto">
  <name>Optimize Task Fetching for User Briefings</name>
  <files>queries/user_tasks.sql</files>
  <action>
1. Analyze current task fetching logic in existing daily briefing workflow
2. Examine tasks table structure and indexing:
   - DESCRIBE tasks
   - SHOW INDEX FROM tasks
   - Check user_id index efficiency
3. Create optimized user-specific task query:
   - Filter by user_id (parameterized)
   - Include relevant tasks (pending, in_progress)
   - Filter by due_date (current and future)
   - Order by priority and due_date
4. Performance testing:
   - Test query with different task volumes per user
   - Measure execution time with EXPLAIN ANALYZE
   - Identify optimization opportunities
5. Add indexing recommendations if needed:
   - Composite index on (user_id, status, due_date)
   - Priority index if missing
6. Save optimized query as queries/user_tasks.sql with parameter documentation
7. Document task categorization logic for briefing generation:
   - Overdue tasks
   - Due today/this week
   - High priority items
   - Recent completed tasks
</action>
  <verify>Run queries/user_tasks.sql with sample user_id and confirm it returns relevant tasks efficiently (< 50ms)</verify>
  <done>User task fetching query optimized with proper indexing and categorization logic documented</done>
</task>

<task type="auto">
  <name>Create Database Performance Documentation</name>
  <files>.planning/phases/01-daily-briefing-refactor/01-01-SUMMARY.md</files>
  <action>
1. Compile database analysis results into comprehensive document:
   - Schema analysis findings
   - Current data volumes and growth patterns
   - Query performance benchmarks
   - Optimization recommendations
2. Create scaling projections:
   - Performance with 10, 50, 100, 500 users
   - Memory usage estimates for batch processing
   - Recommended batch sizes for n8n workflow
3. Document query optimization decisions:
   - Why specific indexes are needed
   - Parameter binding considerations
   - Error handling patterns
4. Create database monitoring recommendations:
   - Query performance monitoring
   - Index usage tracking
   - Scaling thresholds
5. Validate that queries meet daily briefing requirements:
   - Response times under 100ms per query
   - Efficient user iteration support
   - Minimal database load during scheduled runs
6. Update PHASE_ANALYSIS.md with database findings and query optimizations
</action>
  <verify>Review documentation for completeness and validate that all performance requirements are met</verify>
  <done>Comprehensive database analysis and optimization documentation completed with scaling recommendations</done>
</task>

</tasks>

<verification>
- Active users query executes efficiently with current data volume
- Task fetching query supports user-specific filtering and ordering
- Database indexes support optimal query performance
- Performance benchmarks meet daily briefing timing requirements
- Scaling analysis supports growth to 500+ users
- All queries properly parameterized for n8n Supabase node usage
</verification>

<success_criteria>
- Optimized SQL queries for user iteration and task fetching
- Performance benchmarks showing < 100ms query response times
- Database indexing recommendations implemented
- Comprehensive documentation of schema analysis and optimizations
- Scaling projections supporting workflow architecture decisions
- Validation that queries support elimination of hardcoded user chains
</success_criteria>

<output>
After completion, create `.planning/phases/01-daily-briefing-refactor/01-01-SUMMARY.md` documenting:
1. Database schema analysis results
2. Optimized queries with performance benchmarks
3. Indexing recommendations and scaling analysis
4. Task categorization logic for briefing generation
5. Validation that queries support dynamic user iteration architecture
</output>