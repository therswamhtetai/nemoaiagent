---
phase: 01-daily-briefing-refactor
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified: ["workflows/dynamic-daily-briefing.json", ".planning/phases/01-daily-briefing-refactor/01-03-SUMMARY.md"]
autonomous: true
must_haves:
  truths:
    - "Briefing generation works with dynamic user context and preferences"
    - "LLM integration maintains existing briefing quality and format"
    - "Notification system sends user-specific briefings to correct channels"
  artifacts:
    - path: "workflows/dynamic-daily-briefing.json"
      provides: "Complete daily briefing workflow with LLM integration"
      contains: "briefing generation, user preferences, notifications"
    - path: ".planning/phases/01-daily-briefing-refactor/01-03-SUMMARY.md"
      provides: "Briefing generation and notification documentation"
  key_links:
    - from: "dynamic-daily-briefing.json"
      to: "googlePalmApi"
      via: "Basic LLM Chain node"
      pattern: "n8n-nodes-base.basicLlmChain.*models/gemini-3-flash-preview"
    - from: "dynamic-daily-briefing.json"
      to: "ntfy service"
      via: "HTTP Request node"
      pattern: "httpRequest.*ntfy.sh.*nemo-{{username}}"
---

<objective>
Migrate briefing generation and notification logic to work with dynamic user context while maintaining existing functionality and quality.

Purpose: Refactor the core briefing logic from hardcoded user chains to work within the dynamic loop architecture, preserving all existing features.

Output: Complete briefing generation with user-aware LLM prompting and personalized notification delivery.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PHASE_ANALYSIS.md
@.planning/phases/01-daily-briefing-refactor/01-01-SUMMARY.md
@.planning/phases/01-daily-briefing-refactor/01-02-SUMMARY.md
@CLAUDE.md

# Current Briefing Logic (from existing workflow)
- Task categorization (overdue, due today, high priority, recent)
- LLM prompt with ZERO MARKDOWN policy
- ntfy notifications to user-specific topics
- User preference integration (notification time, channel)

# Credential References
googlePalmApi: "qJ3tJlGTxwiZCORz" (Google Gemini)
- Model: models/gemini-3-flash-preview
</context>

<tasks>

<task type="auto">
  <name>Implement Task Categorization Logic</name>
  <files>workflows/dynamic-daily-briefing.json</files>
  <action>
1. Add Code node after "Get User Tasks" to categorize tasks:
   - Node name: "Categorize Tasks"
   - Input: User tasks from Supabase query
   - Categories to implement:
     * Overdue tasks (due_date < TODAY and status != completed)
     * Due today (due_date = TODAY)
     * Due this week (due_date <= TODAY + 7 days)
     * High priority (priority = 'high' and status != completed)
     * Recently completed (status = 'completed' and updated_at >= TODAY - 3 days)

2. Task categorization JavaScript logic:
```javascript
const tasks = $input.first().json;
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
const threeDaysAgo = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000);

const categories = {
  overdue: [],
  due_today: [],
  due_this_week: [],
  high_priority: [],
  recently_completed: []
};

tasks.forEach(task => {
  const dueDate = task.due_date ? new Date(task.due_date) : null;
  const updatedDate = new Date(task.updated_at);
  
  if (task.status !== 'completed') {
    if (dueDate && dueDate < today) {
      categories.overdue.push(task);
    }
    if (dueDate && dueDate.toDateString() === today.toDateString()) {
      categories.due_today.push(task);
    }
    if (dueDate && dueDate <= weekFromNow) {
      categories.due_this_week.push(task);
    }
    if (task.priority === 'high') {
      categories.high_priority.push(task);
    }
  }
  
  if (task.status === 'completed' && updatedDate >= threeDaysAgo) {
    categories.recently_completed.push(task);
  }
});

return [{
  json: {
    user_id: $input.first().json.user_id,
    username: $input.first().json.username,
    task_categories: categories,
    total_tasks: tasks.length,
    urgent_count: categories.overdue.length + categories.due_today.length + categories.high_priority.length
  }
}];
```

3. Test categorization with sample task data:
   - Create test tasks for each category
   - Verify correct classification
   - Check edge cases (null dates, various statuses)
</action>
  <verify>Test categorization logic with sample tasks and confirm all categories are correctly identified</verify>
  <done>Task categorization logic implemented and tested with edge cases</done>
</task>

<task type="auto">
  <name>Integrate User-Aware LLM Briefing Generation</name>
  <files>workflows/dynamic-daily-briefing.json</files>
  <action>
1. Add Basic LLM Chain node for briefing generation:
   - Node name: "Generate Briefing"
   - Model: models/gemini-3-flash-preview
   - Credential: Google Gemini (qJ3tJlGTxwiZCORz)
   - Options: Temperature 0.3, Max tokens 1000

2. Create dynamic system prompt with user context:
```text
You are Nemo, a personal AI assistant generating a daily briefing for {{username}}.

TASK SUMMARY:
Total tasks: {{total_tasks}}
Urgent items: {{urgent_count}}

TASK CATEGORIES:
- Overdue: {{overdue_count}} tasks
- Due today: {{due_today_count}} tasks  
- High priority: {{high_priority_count}} tasks
- Due this week: {{due_this_week_count}} tasks
- Recently completed: {{recently_completed_count}} tasks

Generate a concise, friendly daily briefing in Myanmar timezone. Include:
1. Urgent items first (overdue + due today + high priority)
2. This week's important tasks
3. Recent accomplishments
4. Brief encouragement for the day

Format: Plain text, NO markdown, NO asterisks, NO formatting. Keep under 300 characters if possible, maximum 500 characters.

User preferences: {{notification_channel}} notifications at {{briefing_time}}
```

3. Set up LLM node parameters:
   - System Prompt: Dynamic with user variables
   - User Message: Include categorized task details
   - Pass user context: username, preferences, categories

4. Add Code node to prepare LLM input:
   - Extract user info and preferences
   - Format task categories for LLM
   - Build dynamic system prompt
   - Include user timezone (Asia/Yangon)

5. Add error handling for LLM failures:
   - Fallback to template-based briefing if LLM fails
   - Log LLM generation errors
   - Continue with next user if LLM unavailable

6. Test LLM generation with different user scenarios:
   - User with many urgent tasks
   - User with no urgent tasks
   - User with recently completed items only
   - User with special preferences
</action>
  <verify>Generate test briefings for different user scenarios and confirm quality meets existing standards</verify>
  <done>User-aware LLM briefing generation implemented with proper prompting and error handling</done>
</task>

<task type="auto">
  <name>Implement Dynamic Notification Delivery</name>
  <files>workflows/dynamic-daily-briefing.json</files>
<action>
1. Add HTTP Request node for ntfy notifications:
   - Node name: "Send Notification"
   - Method: POST
   - URL: https://ntfy.sh/nemo-{{username}} (dynamic)
   - Headers: 
     * Content-Type: text/plain
     * Priority: high
     * Tags: briefcase, calendar

2. Configure notification content:
   - Message: Generated briefing from LLM
   - Title: "Daily Briefing - {{current_date}}"
   - Dynamic topic based on username
   - Priority: high for scheduled, default for on-demand

3. Add Code node for notification preparation:
```javascript
const briefing = $input.first().json.briefing;
const user = $input.first().json;
const now = new Date();
const dateStr = now.toLocaleDateString('en-US', { 
  weekday: 'short', 
  month: 'short', 
  day: 'numeric' 
});

// Determine notification channel preference
let notificationChannel = user.notification_channel || 'ntfy';
let priority = 'high'; // Default for scheduled

// Adjust priority based on trigger type
if ($input.first().json.trigger_type === 'on-demand') {
  priority = 'default';
}

// Fallback if ntfy not preferred
if (notificationChannel !== 'ntfy') {
  return [{
    json: {
      user: user.username,
      briefing: briefing,
      channel: 'email_fallback',
      date: dateStr
    }
  }];
}

return [{
  json: {
    user: user.username,
    briefing: briefing,
    channel: 'ntfy',
    topic: `nemo-${user.username}`,
    title: `Daily Briefing - ${dateStr}`,
    priority: priority,
    tags: ['briefcase', 'calendar']
  }
}];
```

4. Add retry logic for failed notifications:
   - HTTP Request: Continue on fail = true
   - Wait node: 30 seconds delay
   - Retry HTTP Request: Up to 3 attempts
   - Log final status after retries

5. Add email fallback option:
   - If ntfy fails repeatedly
   - Use existing email notification workflow
   - Log email fallback usage

6. Add notification logging:
   - Record delivery status per user
   - Log timing and retry attempts
   - Track success/failure rates

7. Test notification delivery:
   - Send test notifications to multiple user topics
   - Verify dynamic topic generation
   - Test retry logic and email fallback
</action>
  <verify>Send test notifications to sample user topics and confirm delivery with proper formatting and retry logic</verify>
  <done>Dynamic notification delivery system implemented with ntfy integration, retry logic, and email fallback</done>
</task>

</tasks>

<verification>
- Task categorization correctly identifies overdue, due today, high priority, and recent items
- LLM generates high-quality briefings in user context with proper Myanmar timezone
- Notifications are sent to correct user-specific ntfy topics
- Retry logic handles temporary notification failures gracefully
- Email fallback works when ntfy is unavailable
- Briefing quality and formatting matches existing standards
- Error handling prevents individual user failures from stopping the workflow
</verification>

<success_criteria>
- Complete briefing generation pipeline working within dynamic user loop
- Task categorization logic handles all edge cases and data scenarios
- LLM integration produces consistent, high-quality briefings with user context
- Notification delivery works for all active users via their preferred channels
- Robust error handling ensures workflow reliability
- Performance maintains acceptable response times per user
- Foundation ready for Web API Router integration in next phase
</success_criteria>

<output>
After completion, create `.planning/phases/01-daily-briefing-refactor/01-03-SUMMARY.md` documenting:
1. Task categorization logic and edge case handling
2. User-aware LLM briefing generation with dynamic prompting
3. Notification delivery system with ntfy integration and fallbacks
4. Error handling and retry mechanisms
5. Quality validation and test results
6. Performance characteristics and optimization notes
</output>