---
phase: 01-daily-briefing-refactor
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: ["workflows/dynamic-daily-briefing.json", ".planning/phases/01-daily-briefing-refactor/01-02-SUMMARY.md"]
autonomous: true
must_haves:
  truths:
    - "Dynamic user iteration workflow eliminates hardcoded user chains"
    - "Multi-trigger support works for scheduled, manual, and webhook execution"
    - "Batch processing handles users efficiently with proper error handling"
  artifacts:
    - path: "workflows/dynamic-daily-briefing.json"
      provides: "Main dynamic daily briefing workflow"
      contains: "triggers, user iteration, batch processing"
    - path: ".planning/phases/01-daily-briefing-refactor/01-02-SUMMARY.md"
      provides: "Workflow architecture documentation"
  key_links:
    - from: "dynamic-daily-briefing.json"
      to: "queries/active_users.sql"
      via: "Supabase node"
      pattern: "supabase.*runQuery.*active_users"
    - from: "dynamic-daily-briefing.json"
      to: "queries/user_tasks.sql"
      via: "Supabase node with user_id parameter"
      pattern: "splitInBatches.*supabase.*user_tasks"
---

<objective>
Build the core loop architecture for dynamic daily briefing workflow with multi-trigger support and user iteration.

Purpose: Replace hardcoded user chains with scalable loop-based architecture that can handle unlimited users without workflow modifications.

Output: Complete n8n workflow with dynamic user iteration, multi-trigger support, and batch processing.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PHASE_ANALYSIS.md
@.planning/codebase/ARCHITECTURE.md
@.planning/phases/01-daily-briefing-refactor/01-01-SUMMARY.md
@CLAUDE.md

# Required Workflow Nodes (from n8n-skills patterns)
- Schedule Trigger (maintain existing timing)
- Manual Trigger (testing/ad-hoc)
- Webhook Trigger (chat integration)
- Supabase Node (database queries)
- Split In Batches (user iteration)
- Code Node (processing logic)
- Wait Node (rate limiting)
- IF Node (error handling)

# Credential References
supabaseApi: "JbItbwVcQiGCLFAC" (NemoAIDatabase)
googlePalmApi: "qJ3tJlGTxwiZCORz" (Google Gemini)
</context>

<tasks>

<task type="auto">
  <name>Create Multi-Trigger Workflow Foundation</name>
  <files>workflows/dynamic-daily-briefing.json</files>
  <action>
1. Create new n8n workflow with basic structure:
   - Name: "Nemo - Daily Briefing v2 (Dynamic)"
   - Description: "Dynamic daily briefing that iterates over active users"
   - Save as workflows/dynamic-daily-briefing.json

2. Configure three parallel trigger nodes:
   - Schedule Trigger: Daily at 8 AM (maintain existing schedule)
     - Mode: "daysAndHours"
     - Days: ["monday", "tuesday", "wednesday", "thursday", "friday"]
     - Hour: 8, Minute: 0
     - Timezone: "Asia/Yangon" (Myanmar timezone)
   
   - Manual Trigger: "Execute Workflow" for testing
     - Button for ad-hoc execution
     - No parameters needed
   
   - Webhook Trigger: POST /webhook/daily-briefing
     - Method: POST
     - Path: daily-briefing
     - Response Mode: "Wait for response"
     - Authentication: None (handled by upstream)

3. Merge trigger outputs to single processing path:
   - Use Merge node with "Combine All" mode
   - Add source identification (trigger_type field)
   - Pass through any webhook parameters (user_id for on-demand)

4. Add Set node to normalize input:
   - Extract trigger_type (scheduled/manual/on-demand)
   - Handle webhook parameters (optional user_id)
   - Set execution_start_time = $now

5. Test workflow structure with n8n validation before proceeding
</action>
  <verify>Validate workflow structure with n8n MCP tools and confirm all triggers are properly configured</verify>
  <done>Multi-trigger workflow foundation created with normalized input processing</done>
</task>

<task type="auto">
  <name>Implement Dynamic User Iteration Logic</name>
  <files>workflows/dynamic-daily-briefing.json</files>
  <action>
1. Add Supabase node for active users query:
   - Node name: "Get Active Users"
   - Operation: "Run Query"
   - Credential: NemoAIDatabase
   - Query: Use optimized active_users.sql from Phase 1
   - Parameters: None (fetches all active users)

2. Add IF node to handle on-demand single user mode:
   - Condition: If webhook trigger with user_id parameter
   - True path: Filter users array to specific user
   - False path: Use all active users (scheduled/manual)

3. Add Split In Batches node for user iteration:
   - Node name: "Process Users"
   - Batch size: 1 (process one user at a time)
   - Options: Reset for each batch, Continue on fail
   - This creates the loop structure for dynamic processing

4. Add Code node after Split In Batches to prepare user context:
   - Extract current user from batch: $input.first().json
   - Set user_id, username, notification_channel
   - Calculate briefing_time preference or use default
   - Prepare metadata for briefing generation

5. Add Supabase node for user-specific tasks:
   - Node name: "Get User Tasks"
   - Operation: "Run Query" 
   - Query: Use optimized user_tasks.sql from Phase 1
   - Parameters: user_id from user context

6. Add basic error handling:
   - Supabase nodes: Continue on fail = true
   - IF nodes to check for empty results
   - Code node to log processing status per user

7. Test user iteration with sample data
</action>
  <verify>Execute workflow with test data and confirm it processes each user individually with their tasks</verify>
  <done>Dynamic user iteration logic implemented with proper batching and error handling</done>
</task>

<task type="auto">
  <name>Add Loop Completion and Aggregation Logic</name>
  <files>workflows/dynamic-driefing.json</files>
  <action>
1. Add aggregation logic after Split In Batches completes:
   - Use Merge node after the loop to collect all results
   - Mode: "Combine All Input Items"
   - This collects per-user processing results

2. Add Code node for execution summary:
   - Count successful briefings generated
   - Count failed user processing
   - Calculate total execution time
   - Generate summary statistics

3. Add IF node for different completion handling:
   - Scheduled mode: Log completion, send admin notification
   - Manual mode: Return execution summary to trigger
   - On-demand mode: Return specific user briefing to webhook

4. Add error handling and logging:
   - Try/Catch pattern around user processing
   - Log individual user failures without stopping whole workflow
   - Collect error details for final summary

5. Add final response formatting:
   - For webhook: JSON response with briefing content
   - For scheduled: Simple success message
   - For manual: Detailed execution report

6. Add monitoring and metrics:
   - Execution duration tracking
   - Success/failure rates
   - Performance metrics per user

7. Validate complete workflow structure:
   - All nodes properly connected
   - Error paths configured
   - Response handling complete for all trigger types
</action>
  <verify>Run complete workflow test and confirm it processes users, handles errors, and returns appropriate responses for all trigger types</verify>
  <done>Complete loop architecture with aggregation, error handling, and multi-format responses</done>
</task>

</tasks>

<verification>
- All three trigger types (scheduled, manual, webhook) are functional
- User iteration works with dynamic user count from database
- Split In Batches correctly processes one user at a time
- Error handling continues processing when individual users fail
- On-demand mode works with specific user_id from webhook
- Workflow structure passes n8n validation
- Performance is acceptable for current user volume
</verification>

<success_criteria>
- Dynamic daily briefing workflow replaces hardcoded user chains
- Multi-trigger support enables scheduled, manual, and chat-initiated execution
- User iteration scales without workflow modifications for new users
- Proper error handling ensures workflow continues when individual users fail
- Response formatting is appropriate for different trigger contexts
- Foundation is ready for briefing generation integration in next phase
</success_criteria>

<output>
After completion, create `.planning/phases/01-daily-briefing-refactor/01-02-SUMMARY.md` documenting:
1. Multi-trigger workflow architecture
2. Dynamic user iteration implementation
3. Batch processing and error handling patterns
4. Response handling for different trigger types
5. Validation results and performance characteristics
6. Foundation ready for briefing generation integration
</output>