---
phase: 01-daily-briefing-refactor
plan: 04
type: execute
wave: 2
depends_on: ["01-02", "01-03"]
files_modified: ["workflows/core/web-api-router_o5t83JWF11dsSfyi.json", "workflows/dynamic-daily-briefing-sub.json", ".planning/phases/01-daily-briefing-refactor/01-04-SUMMARY.md"]
autonomous: true
must_haves:
  truths:
    - "Daily briefing tool is callable from main chat interface"
    - "Web API Router correctly routes briefing requests to new workflow"
    - "On-demand briefings work with proper user authentication"
  artifacts:
    - path: "workflows/core/web-api-router_o5t83JWF11dsSfyi.json"
      provides: "Updated main router with daily briefing tool"
      contains: "AI Agent with new daily briefing tool"
    - path: "workflows/dynamic-daily-briefing-sub.json"
      provides: "Sub-workflow for on-demand briefing execution"
      contains: "Execute Workflow trigger, user authentication, response formatting"
    - path: ".planning/phases/01-daily-briefing-refactor/01-04-SUMMARY.md"
      provides: "Web API Router integration documentation"
  key_links:
    - from: "web-api-router_o5t83JWF11dsSfyi.json"
      to: "dynamic-daily-briefing-sub.json"
      via: "toolWorkflow node"
      pattern: "toolWorkflow.*Execute Workflow.*daily-briefing"
    - from: "web-api-router_o5t83JWF11dsSfyi.json"
      to: "googlePalmApi"
      via: "AI Agent node"
      pattern: "n8n-nodes-base.agent.*daily briefing.*tool"
---

<objective>
Integrate daily briefing as a callable tool within the Web API Router to enable on-demand briefings from the chat interface.

Purpose: Connect the dynamic daily briefing workflow to the main chat system so users can request briefings using natural language like "Today's briefing" or "What's on my plate".

Output: Updated Web API Router with daily briefing tool and sub-workflow for on-demand execution.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PHASE_ANALYSIS.md
@.planning/phases/01-daily-briefing-refactor/01-03-SUMMARY.md
@CLAUDE.md

# Current Web API Router Structure
- Workflow ID: o5t83JWF11dsSfyi
- Main AI Agent with multiple tools
- Existing tools: task_manager, business_strategist, market_intel, etc.
- Credential: googlePalmApi with models/gemini-3-flash-preview

# Tool Integration Pattern
- AI Agent node with tool descriptions
- toolWorkflow nodes call sub-workflows
- Execute Workflow trigger in sub-workflows
- Response formatting for chat interface

# Authentication Requirements
- User authentication via JWT tokens
- User_id extraction for personalization
- Rate limiting for resource protection
</context>

<tasks>

<task type="auto">
  <name>Create Daily Briefing Sub-Workflow</name>
  <files>workflows/dynamic-daily-briefing-sub.json</files>
  <action>
1. Create new sub-workflow for on-demand briefing execution:
   - Name: "Daily Briefing - On Demand"
   - Description: "Sub-workflow called by Web API Router for on-demand daily briefings"
   - Save as workflows/dynamic-daily-briefing-sub.json

2. Add Execute Workflow trigger:
   - Node name: "Execute Workflow Trigger"
   - Wait for webhook: false (direct execution)
   - Expected input fields: user_id, message_text, context

3. Add user authentication validation:
   - Code node to validate user_id
   - Check if user exists and is active
   - Extract user preferences for briefing format

4. Add call to main daily briefing workflow:
   - HTTP Request node to call webhook trigger
   - URL: https://admin.orcadigital.online/webhook/daily-briefing
   - Method: POST
   - Body: { "user_id": "{{user_id}}", "trigger_type": "on-demand" }
   - Headers: Content-Type: application/json

5. Add response formatting for chat interface:
   - Parse briefing response from main workflow
   - Format for chat: friendly tone, no markdown
   - Add context: "Here's your daily briefing for today"

6. Add error handling:
   - If user not found: "I couldn't find your account. Please check your login."
   - If briefing fails: "Sorry, I couldn't generate your briefing right now. Please try again later."
   - If no tasks: "You don't have any active tasks. Great job staying organized!"

7. Test sub-workflow with sample user data:
   - Execute with valid user_id
   - Execute with invalid user_id
   - Test error scenarios
</action>
  <verify>Execute sub-workflow with test data and confirm it returns properly formatted briefings for chat interface</verify>
  <done>Daily briefing sub-workflow created with authentication, API call, and response formatting</done>
</task>

<task type="auto">
  <name>Add Daily Briefing Tool to Web API Router</name>
  <files>workflows/core/web-api-router_o5t83JWF11dsSfyi.json</files>
  <action>
1. Load existing Web API Router workflow:
   - Read workflows/core/web-api-router_o5t83JWF11dsSfyi.json
   - Identify AI Agent node with existing tools
   - Note current tool structure and patterns

2. Add daily briefing tool to AI Agent:
   - Tool name: "daily_briefing"
   - Description: "Generate daily briefing with task summary. Use when user asks for 'briefing', 'today summary', 'what's on my plate', 'what are my tasks for today', or similar requests."
   - Parameters: none (uses authenticated user context)

3. Add toolWorkflow node to call sub-workflow:
   - Node name: "Daily Briefing Tool"
   - Workflow: "Daily Briefing - On Demand" (created in Task 1)
   - Pass input: user_id, original message, conversation context
   - Execute mode: wait for response

4. Update AI Agent system prompt to include new tool:
   - Add mention of daily briefing capability
   - Clarify when to use the tool
   - Maintain existing ZERO MARKDOWN policy

5. Add routing logic in AI Agent:
   - Detect briefing request patterns
   - Choose appropriate tool based on user intent
   - Handle follow-up questions about briefing content

6. Add error handling for tool integration:
   - If sub-workflow fails: graceful fallback message
   - If user not authenticated: prompt for login
   - Rate limiting: prevent excessive briefing requests

7. Update tool ordering and priorities:
   - Place daily briefing appropriately in tool selection
   - Ensure it doesn't conflict with existing task management tools
   - Maintain existing tool functionality

8. Test updated Web API Router:
   - Send "Today's briefing" message
   - Send "What's on my plate today?" message
   - Verify correct tool selection and execution
</action>
  <verify>Test Web API Router with various briefing request patterns and confirm correct tool selection and response</verify>
  <done>Web API Router updated with daily briefing tool and proper routing logic</done>
</task>

<task type="auto">
  <name>Implement User Authentication and Rate Limiting</name>
  <files>workflows/dynamic-daily-briefing-sub.json</files>
  <action>
1. Add JWT token validation in sub-workflow:
   - Extract token from incoming request headers
   - Validate token using existing auth system
   - Extract user_id and session information

2. Add user authentication checks:
```javascript
// Code node for authentication
const token = $input.first().json.authorization?.replace('Bearer ', '');
if (!token) {
  return [{
    json: { 
      error: "Authentication required", 
      message: "Please log in to request your daily briefing" 
    }
  }];
}

// Validate token (implement JWT validation)
try {
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  const userId = decoded.userId;
  
  // Additional validation
  if (!userId) {
    throw new Error('Invalid token structure');
  }
  
  return [{
    json: {
      user_id: userId,
      authenticated: true,
      token_valid: true
    }
  }];
} catch (error) {
  return [{
    json: { 
      error: "Authentication failed", 
      message: "Your session has expired. Please log in again." 
    }
  }];
}
```

3. Add rate limiting for on-demand briefings:
   - Use Redis or database to track request frequency
   - Limit: 1 briefing per user per 5 minutes
   - Limit: 10 briefings per user per day

4. Add user preference integration:
   - Check user notification preferences
   - Respect briefing time preferences
   - Handle opt-out preferences gracefully

5. Add context preservation:
   - Include conversation context in briefing request
   - Allow follow-up questions about briefing
   - Maintain chat flow continuity

6. Add monitoring and logging:
   - Log all briefing requests (user, timestamp, success/failure)
   - Track popular request patterns
   - Monitor for abuse or excessive usage

7. Test authentication and rate limiting:
   - Test with invalid/expired tokens
   - Test rate limiting boundaries
   - Test with various user preference configurations
</action>
  <verify>Test authentication scenarios and rate limiting to ensure proper security and usage controls</verify>
  <done>Robust authentication, rate limiting, and user preference integration implemented</done>
</task>

</tasks>

<verification>
- Daily briefing sub-workflow executes correctly when called from Web API Router
- Web API Router AI Agent correctly identifies briefing requests and routes to appropriate tool
- User authentication works properly with JWT token validation
- Rate limiting prevents abuse while allowing legitimate usage
- Response formatting is appropriate for chat interface
- Error handling provides helpful user feedback for various failure scenarios
- Integration maintains existing Web API Router functionality
</verification>

<success_criteria>
- Users can request daily briefings using natural language in chat
- Web API Router correctly routes briefing requests to new dynamic workflow
- Authentication and authorization ensure only valid users can access their briefings
- Rate limiting protects system resources while allowing reasonable usage
- Response formatting maintains chat interface consistency
- Error handling provides helpful feedback for various failure scenarios
- Integration doesn't break existing Web API Router functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-daily-briefing-refactor/01-04-SUMMARY.md` documenting:
1. Daily briefing sub-workflow design and implementation
2. Web API Router integration with new tool
3. Authentication and authorization implementation
4. Rate limiting and user preference handling
5. Response formatting and error handling
6. Testing results and validation of chat integration
7. User experience improvements with on-demand briefing capability
</output>