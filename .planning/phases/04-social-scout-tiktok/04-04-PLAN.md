# Plan 04-04: AI Analysis Updates

## Wave Overview
- **Phase:** 04 - TikTok & Viral Analysis for Social Scout
- **Wave:** 4 of 5
- **Focus:** Update LLM prompts for multi-platform support and add viral content analysis
- **Estimated Time:** 45 minutes

## Goal
Enable AI to analyze both Facebook and TikTok data, with specialized viral content analysis for TikTok videos.

---

## Tasks

### Task 4.1: Update Basic LLM Chain Prompt
**Source Todo:** `2026-01-28-update-llm-prompt-tiktok-analysis.md`
**Priority:** Medium
**Node ID:** `cd8af0e1-4eae-4125-aaae-76c62d501152`

Update prompt to handle both platforms:

```
Analyze this {{ $('Normalize Input').item.json.platform }} social media data for the competitor: {{ $('Normalize Input').item.json.target }}

Here is the raw data:
{{ $json.merged_text }}

{% if $('Normalize Input').item.json.platform === 'tiktok' %}
Please extract and summarize:
1. Total Followers (from authorMeta.fans)
2. Total Hearts/Likes (from authorMeta.heart)
3. Engagement Rate (average of playCount, diggCount across videos)
4. Content Strategy: What kind of content? (Video duration, hashtags)
5. Top Performing Video: Highest playCount
6. Viral Score (1-10): Based on engagement ratio

Output strictly in JSON format:
{
  "platform": "tiktok",
  "followers": 12345,
  "total_hearts": 123456,
  "viral_score": 8,
  "summary": "They focus on short-form content about...",
  "top_post": "The video about...",
  "avg_engagement": 5.2
}
{% else %}
Please extract and summarize:
1. Total Follower Count
2. Engagement Rate (Estimate based on last 5 posts)
3. Content Strategy: What kind of posts? (Video/Photo?)
4. Top Performing Post: Which got most likes/shares?
5. Viral Score (1-10): How trendy is this page?
6. Is this page currently running ads?

Output strictly in JSON format:
{
  "platform": "facebook",
  "followers": 12345,
  "ads_running": true/false,
  "viral_score": 8,
  "summary": "They are focusing on...",
  "top_post": "The video about..."
}
{% endif %}
```

**Alternative (if Jinja doesn't work):**
Use n8n ternary expression:
```
={{ $('Normalize Input').item.json.platform === 'tiktok' ? 
'[TikTok prompt]' : 
'[Facebook prompt]' }}
```

**Verification:**
- [ ] Prompt updated to detect platform
- [ ] TikTok-specific fields referenced (fans, hearts, playCount)
- [ ] Facebook-specific fields retained (ads_running)
- [ ] JSON output includes platform field
- [ ] Tested with both platforms

---

### Task 4.2: Add Viral Analysis LLM Chain Node
**Source Todo:** `2026-01-28-add-viral-analysis-ai-prompt.md`
**Priority:** Medium

Add specialized node for viral content analysis on TikTok videos:

```json
{
  "parameters": {
    "promptType": "define",
    "text": "=You are a viral content analyst specializing in TikTok. Analyze this video that achieved {{ $json.playCount }} views.\n\nVIDEO DATA:\n- Caption: {{ $json.text }}\n- Duration: {{ $json.videoMeta.duration }} seconds\n- Likes: {{ $json.diggCount }}\n- Shares: {{ $json.shareCount }}\n- Comments: {{ $json.commentCount }}\n- Hashtags: {{ $json.hashtags.map(h => '#' + h.name).join(' ') }}\n- Music: {{ $json.musicMeta.musicName }}\n\nANALYZE THE FOLLOWING:\n\n1. HOOK ANALYSIS (First 3 seconds)\n   - What hook technique was used?\n   - Why does it stop the scroll?\n\n2. SPEECH STRUCTURE\n   - How is the content organized?\n   - What's the pacing like?\n\n3. CAPTION & WRITING STYLE\n   - Tone (casual, professional, humorous?)\n   - Use of emojis, hashtags\n   - Call-to-action presence\n\n4. ENGAGEMENT TRIGGERS\n   - What makes viewers like/share/comment?\n   - Is there controversy, relatability, or surprise?\n\n5. MUSIC/AUDIO CHOICE\n   - How does the audio complement the content?\n\n6. VIRAL FACTORS SUMMARY\n   - List the top 3 reasons this went viral\n\nOutput in JSON format:\n{\n  \"hook_type\": \"curiosity gap\",\n  \"hook_text\": \"The opening line...\",\n  \"speech_structure\": \"Problem → Solution → CTA\",\n  \"pacing\": \"Fast-paced with quick cuts\",\n  \"caption_style\": {\n    \"tone\": \"casual and relatable\",\n    \"emoji_usage\": \"moderate\",\n    \"cta\": \"Follow for more\"\n  },\n  \"engagement_triggers\": [\"relatability\", \"surprise ending\"],\n  \"audio_analysis\": \"Trending sound that adds energy\",\n  \"viral_factors\": [\n    \"Strong hook in first 2 seconds\",\n    \"Relatable problem everyone faces\",\n    \"Unexpected twist at the end\"\n  ],\n  \"recreate_tips\": \"To recreate this success: 1) Start with a provocative question...\"\n}",
    "messages": {
      "messageValues": [{
        "message": "You are a viral content strategist. Provide actionable insights that a business owner can use to create similar successful content. Be specific and practical."
      }]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.chainLlm",
  "typeVersion": 1.9,
  "position": [1700, 100],
  "name": "Viral Analysis"
}
```

**Trigger Condition:**
Only run when:
- `platform === 'tiktok'`
- `is_post === true` (single video URL)

**Connection:**
- Add conditional branch after Get Dataset
- Only route to Viral Analysis for TikTok video URLs

**Verification:**
- [ ] Viral Analysis node added
- [ ] Triggers only for TikTok video URLs
- [ ] Analyzes hook, structure, caption, engagement
- [ ] Outputs actionable recreate_tips
- [ ] Follows ZERO MARKDOWN POLICY
- [ ] JSON output properly formatted

---

### Task 4.3: Add Strategic Follow-up Conversation
**Source Todo:** `2026-01-28-add-strategic-followup-chat.md`
**Priority:** Low
**Node ID:** `f45eba75-bd6c-4d85-b8ca-16fddb312aca` (Basic LLM Chain1)

Append follow-up options after viral analysis:

Add to system message:
```
When the analysis includes viral content breakdown (hook_type, viral_factors, recreate_tips), always end your response with:

---

NEXT STEPS

I can help you apply these viral strategies to your business. Would you like me to:

1. Generate content ideas based on this viral pattern
2. Write a script following this structure for your product/service
3. Suggest trending audio that matches your brand

Just let me know what you'd like to explore!
```

**Alternative (conditional append):**
```javascript
={{ $json.text + ($('Normalize Input').item.json.is_post && $('Normalize Input').item.json.platform === 'tiktok' ? 
'\n\n---\n\nNEXT STEPS\n\nWould you like me to help you recreate this viral strategy for your business? I can:\n\n1. Generate content ideas based on this pattern\n2. Write a script following this structure\n3. Suggest implementation steps\n\nJust let me know!' : '') }}
```

**Verification:**
- [ ] Follow-up question appears after viral analysis
- [ ] Only appears for TikTok video analysis
- [ ] Follows ZERO MARKDOWN POLICY (no **, no ###)
- [ ] Actionable options provided
- [ ] Natural conversational tone

---

## Workflow Structure After Wave 4

```
... → Get Dataset →
  [If TikTok + is_post] → Viral Analysis → Merge Results
  [Otherwise] → Pass Through
→ Update Row → Merge Text → Basic LLM Chain (updated) →
→ Parse JSON → Create Social Stats → Basic LLM Chain1 (with follow-up)
```

---

## Execution Order

1. Update Basic LLM Chain prompt (Task 4.1)
2. Add Viral Analysis node (Task 4.2)
3. Add conditional routing for viral analysis
4. Update Basic LLM Chain1 for follow-up (Task 4.3)
5. Test with various URL types

---

## Test Cases

| URL Type | Expected Analysis |
|----------|-------------------|
| Facebook page | Standard analysis, ads_running field |
| TikTok profile | TikTok metrics (fans, hearts) |
| TikTok video | Full viral analysis + recreate_tips + follow-up |

---

## Dependencies

- **Requires:** Wave 3 complete (Scrapers provide data)
- **Blocks:** Nothing (Wave 5 is independent)

---

## Success Criteria

- [ ] Basic LLM Chain handles both platforms correctly
- [ ] Viral Analysis runs for TikTok videos only
- [ ] Viral analysis includes hook/structure/engagement analysis
- [ ] Recreate tips are actionable and specific
- [ ] Follow-up conversation appears for viral analysis
- [ ] All outputs follow ZERO MARKDOWN POLICY

---

## Related Todos
- `.planning/todos/pending/2026-01-28-update-llm-prompt-tiktok-analysis.md`
- `.planning/todos/pending/2026-01-28-add-viral-analysis-ai-prompt.md`
- `.planning/todos/pending/2026-01-28-add-strategic-followup-chat.md`
