# Plan 04-02: Platform Detection & Routing

## Wave Overview
- **Phase:** 04 - TikTok & Viral Analysis for Social Scout
- **Wave:** 2 of 5
- **Focus:** Add platform detection to Normalize Input and routing Switch node
- **Estimated Time:** 30 minutes

## Goal
Enable the workflow to detect whether a URL is Facebook or TikTok, and route to the appropriate scraper.

---

## Tasks

### Task 2.1: Modify Normalize Input Code Node
**Source Todo:** `2026-01-28-add-platform-detection-normalize-input.md`
**Priority:** High
**Node ID:** `47f3293c-a540-4168-b8eb-25ba492fd306`

Update the JavaScript code to detect platform and post type:

```javascript
const inputData = $input.first().json;

// 1. Target URL extraction (existing logic)
let targetUrl = 
  inputData.target || 
  inputData.link ||
  (inputData.body && inputData.body.target) || 
  (inputData.body && inputData.body.link) ||
  (inputData.query && inputData.query.target) || 
  (inputData.query && inputData.query.link) ||
  inputData['target ']; 

if (!targetUrl) {
  targetUrl = 'https://www.facebook.com/dalaestore.mm';
}

// 2. User ID extraction (existing logic)
let userId = 
  inputData.user_id || 
  (inputData.body && inputData.body.user_id) || 
  (inputData.query && inputData.query.user_id);

// 3. NEW: Platform detection
let platform = 'facebook'; // default
if (targetUrl.includes('tiktok.com')) {
  platform = 'tiktok';
}

// 4. NEW: Detect if URL is a post vs page/profile
let isPost = targetUrl.includes('/posts/') || 
             targetUrl.includes('/videos/') || 
             targetUrl.includes('/video/') ||
             targetUrl.includes('/reel/');

return {
  json: {
    target: targetUrl.trim(),
    user_id: userId,
    platform: platform,      // NEW
    is_post: isPost          // NEW
  }
};
```

**Verification:**
- [ ] Code node updated via n8n API
- [ ] Returns `platform: "facebook"` for facebook.com URLs
- [ ] Returns `platform: "tiktok"` for tiktok.com URLs
- [ ] Returns `is_post: true` for /posts/, /videos/, /video/, /reel/ URLs
- [ ] Returns `is_post: false` for page/profile URLs

---

### Task 2.2: Add Platform Router Switch Node
**Source Todo:** `2026-01-28-add-switch-node-platform-routing.md`
**Priority:** High

Add a new Switch node after `Code: Merge ID` to route based on platform:

```json
{
  "parameters": {
    "rules": {
      "values": [
        {
          "conditions": {
            "conditions": [{
              "leftValue": "={{ $('Normalize Input').item.json.platform }}",
              "rightValue": "tiktok",
              "operator": { 
                "type": "string", 
                "operation": "equals" 
              }
            }],
            "combinator": "and"
          },
          "outputKey": "tiktok"
        }
      ]
    },
    "options": { 
      "fallbackOutput": "extra" 
    }
  },
  "type": "n8n-nodes-base.switch",
  "typeVersion": 3.2,
  "position": [500, -80],
  "id": "GENERATE_NEW_UUID",
  "name": "Platform Router"
}
```

**Connection Updates:**
- Disconnect: `Code: Merge ID` → `Apify`
- Connect: `Code: Merge ID` → `Platform Router`
- Connect: `Platform Router` (output 0: tiktok) → `Apify TikTok` (Wave 3)
- Connect: `Platform Router` (fallback: facebook) → `Apify` (existing)

**Verification:**
- [ ] Switch node added with correct position
- [ ] Routes to TikTok output for tiktok.com URLs
- [ ] Falls back to Facebook output for all other URLs
- [ ] Connections properly wired
- [ ] Workflow validates in n8n

---

## Execution Order

1. Fetch current workflow JSON
2. Update Normalize Input code (Task 2.1)
3. Add Platform Router Switch node (Task 2.2)
4. Update connections
5. Deploy and test with both Facebook and TikTok URLs

---

## Test Cases

| URL | Expected Platform | Expected is_post |
|-----|-------------------|------------------|
| `https://www.facebook.com/dalaestore.mm` | facebook | false |
| `https://www.facebook.com/page/posts/123` | facebook | true |
| `https://www.tiktok.com/@username` | tiktok | false |
| `https://www.tiktok.com/@user/video/123` | tiktok | true |

---

## Dependencies

- **Requires:** Wave 1 complete (database ready)
- **Blocks:** Wave 3 (Scrapers need routing)

---

## Success Criteria

- [ ] Normalize Input detects platform correctly
- [ ] Normalize Input detects post type correctly
- [ ] Platform Router added to workflow
- [ ] Facebook URLs still route to existing Apify node
- [ ] TikTok output ready for Wave 3 connection

---

## Related Todos
- `.planning/todos/pending/2026-01-28-add-platform-detection-normalize-input.md`
- `.planning/todos/pending/2026-01-28-add-switch-node-platform-routing.md`
