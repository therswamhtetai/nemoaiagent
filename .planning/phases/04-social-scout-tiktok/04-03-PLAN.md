# Plan 04-03: Scrapers

## Wave Overview
- **Phase:** 04 - TikTok & Viral Analysis for Social Scout
- **Wave:** 3 of 5
- **Focus:** Add TikTok Scraper and Facebook Posts Scraper nodes
- **Estimated Time:** 45 minutes

## Goal
Add scraping capability for TikTok profiles/videos and individual Facebook posts.

---

## Tasks

### Task 3.1: Add TikTok Scraper Apify Node
**Source Todo:** `2026-01-28-add-tiktok-scraper-apify-node.md`
**Priority:** High

Add new Apify node for TikTok scraping:

```json
{
  "parameters": {
    "actorSource": "store",
    "actorId": {
      "__rl": true,
      "value": "GdWCkxBtKWOsKjdch",
      "mode": "list",
      "cachedResultName": "TikTok Scraper (clockworks/tiktok-scraper)",
      "cachedResultUrl": "https://console.apify.com/actors/GdWCkxBtKWOsKjdch/input"
    },
    "customBody": "={\n  \"profiles\": [\"{{ $('Normalize Input').item.json.target.replace('https://www.tiktok.com/@', '').replace('https://tiktok.com/@', '').split('/')[0].split('?')[0] }}\"],\n  \"postURLs\": {{ $('Normalize Input').item.json.is_post ? '[\"' + $('Normalize Input').item.json.target + '\"]' : '[]' }},\n  \"resultsPerPage\": 5,\n  \"profileScrapeSections\": [\"videos\"],\n  \"profileSorting\": \"latest\",\n  \"shouldDownloadSubtitles\": true,\n  \"shouldDownloadCovers\": false,\n  \"shouldDownloadVideos\": false\n}",
    "memory": 4096
  },
  "type": "@apify/n8n-nodes-apify.apify",
  "typeVersion": 1,
  "position": [656, 100],
  "id": "GENERATE_NEW_UUID",
  "name": "Apify TikTok",
  "credentials": {
    "apifyApi": {
      "id": "nkDHhtz7koGci1VE",
      "name": "Apify account"
    }
  }
}
```

**Apify Actor Details:**
- **Actor ID:** `GdWCkxBtKWOsKjdch`
- **Name:** clockworks/tiktok-scraper
- **Key Data Fields:**
  - `authorMeta.fans` (followers)
  - `authorMeta.heart` (total likes)
  - `playCount`, `diggCount`, `shareCount`, `commentCount`
  - `videoMeta.duration`
  - `subtitleLinks` (for viral analysis)
  - `hashtags[]`

**Connections:**
- Connect: `Platform Router` (tiktok output) → `Apify TikTok`
- Connect: `Apify TikTok` → `Get Dataset` (reuse existing node)

**Verification:**
- [ ] Apify TikTok node added with correct actor ID
- [ ] Credentials reference existing Apify account
- [ ] Profile username extracted correctly from URL
- [ ] Post URLs passed when is_post is true
- [ ] Subtitles enabled for viral analysis
- [ ] Connected to Get Dataset node

---

### Task 3.2: Add Facebook Posts Scraper Node
**Source Todo:** `2026-01-28-add-facebook-posts-scraper.md`
**Priority:** Medium

Add node for individual Facebook posts:

```json
{
  "parameters": {
    "actorSource": "store",
    "actorId": {
      "__rl": true,
      "value": "KoJrdxJCTtpon81KY",
      "mode": "list",
      "cachedResultName": "Facebook Posts Scraper (apify/facebook-posts-scraper)",
      "cachedResultUrl": "https://console.apify.com/actors/KoJrdxJCTtpon81KY/input"
    },
    "customBody": "={\n  \"startUrls\": [{ \"url\": \"{{ $('Normalize Input').item.json.target }}\" }],\n  \"resultsLimit\": 1,\n  \"captionText\": true\n}",
    "memory": 4096
  },
  "type": "@apify/n8n-nodes-apify.apify",
  "typeVersion": 1,
  "position": [656, -200],
  "id": "GENERATE_NEW_UUID",
  "name": "Apify FB Posts",
  "credentials": {
    "apifyApi": {
      "id": "nkDHhtz7koGci1VE",
      "name": "Apify account"
    }
  }
}
```

**Apify Actor Details:**
- **Actor ID:** `KoJrdxJCTtpon81KY`
- **Name:** apify/facebook-posts-scraper
- **Key Fields:** `likes`, `comments`, `shares`, `reactionLikeCount`, `text`, `media[]`

---

### Task 3.3: Add Facebook Sub-Router
**Priority:** Medium

Add Switch node to route Facebook page vs post URLs:

```json
{
  "parameters": {
    "rules": {
      "values": [
        {
          "conditions": {
            "conditions": [{
              "leftValue": "={{ $('Normalize Input').item.json.is_post }}",
              "rightValue": true,
              "operator": { 
                "type": "boolean", 
                "operation": "equals" 
              }
            }],
            "combinator": "and"
          },
          "outputKey": "post"
        }
      ]
    },
    "options": { 
      "fallbackOutput": "extra" 
    }
  },
  "type": "n8n-nodes-base.switch",
  "typeVersion": 3.2,
  "position": [580, -140],
  "id": "GENERATE_NEW_UUID",
  "name": "FB Post Router"
}
```

**Connection Updates:**
- Connect: `Platform Router` (fallback) → `FB Post Router`
- Connect: `FB Post Router` (post output) → `Apify FB Posts`
- Connect: `FB Post Router` (fallback: page) → `Apify` (existing)

---

### Task 3.4: Update Row Node for Multi-Platform
**Source Todo:** `2026-01-28-update-database-platform-field.md`
**Priority:** Low
**Node ID:** `0b84b603-e8f4-49bd-883d-1d223978a846`

Update the "Update a row" Supabase node to handle both platforms:

```json
{
  "parameters": {
    "operation": "update",
    "tableId": "competitors",
    "filters": {
      "conditions": [{
        "keyName": "id",
        "condition": "eq",
        "keyValue": "={{ $('Code: Merge ID').item.json.competitor_id }}"
      }]
    },
    "fieldsUi": {
      "fieldValues": [
        { 
          "fieldId": "name", 
          "fieldValue": "={{ $json.title || $json.authorMeta?.nickName || $json.authorMeta?.name }}" 
        },
        { 
          "fieldId": "last_scraped_at", 
          "fieldValue": "={{ $now.toISO() }}" 
        },
        { 
          "fieldId": "platform", 
          "fieldValue": "={{ $('Normalize Input').item.json.platform }}" 
        },
        { 
          "fieldId": "url", 
          "fieldValue": "={{ $json.pageUrl || $json.authorMeta?.profileUrl || $('Normalize Input').item.json.target }}" 
        }
      ]
    }
  }
}
```

**Field Mapping:**
| Field | Facebook Source | TikTok Source |
|-------|-----------------|---------------|
| name | `$json.title` | `$json.authorMeta.nickName` |
| url | `$json.pageUrl` | `$json.authorMeta.profileUrl` |
| platform | 'facebook' | 'tiktok' |

**Verification:**
- [ ] Update node handles TikTok authorMeta structure
- [ ] Platform field correctly set to 'facebook' or 'tiktok'

---

## Workflow Structure After Wave 3

```
Normalize Input → Get Competitor → If Exists? → Code: Merge ID →
  Platform Router →
    [TikTok] → Apify TikTok → Get Dataset → ...
    [Facebook] → FB Post Router →
      [Post] → Apify FB Posts → Get Dataset → ...
      [Page] → Apify (existing) → Get Dataset → ...
  → Update Row → Merge Text → Basic LLM Chain → ...
```

---

## Execution Order

1. Add `Apify TikTok` node
2. Add `Apify FB Posts` node
3. Add `FB Post Router` Switch node
4. Update connections from Platform Router
5. Update `Update a row` node for multi-platform
6. Connect all scraper outputs to existing `Get Dataset` node
7. Test with all URL types

---

## Test Cases

| URL | Expected Scraper |
|-----|------------------|
| `https://facebook.com/page` | Apify (existing) |
| `https://facebook.com/page/posts/123` | Apify FB Posts |
| `https://tiktok.com/@user` | Apify TikTok |
| `https://tiktok.com/@user/video/123` | Apify TikTok |

---

## Dependencies

- **Requires:** Wave 2 complete (Platform Router exists)
- **Blocks:** Wave 4 (LLM needs data from scrapers)

---

## Success Criteria

- [ ] TikTok Scraper node added and connected
- [ ] Facebook Posts Scraper node added and connected
- [ ] FB Post Router routes correctly
- [ ] Update Row handles both platform data structures
- [ ] All scrapers output to Get Dataset node
- [ ] Workflow validates in n8n

---

## Related Todos
- `.planning/todos/pending/2026-01-28-add-tiktok-scraper-apify-node.md`
- `.planning/todos/pending/2026-01-28-add-facebook-posts-scraper.md`
- `.planning/todos/pending/2026-01-28-update-database-platform-field.md`
