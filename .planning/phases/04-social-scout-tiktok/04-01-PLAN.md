# Plan 04-01: Database Foundation

## Wave Overview
- **Phase:** 04 - TikTok & Viral Analysis for Social Scout
- **Wave:** 1 of 5
- **Focus:** Database schema updates for multi-platform support and ad monitoring
- **Estimated Time:** 30 minutes

## Goal
Prepare the database schema to support TikTok as a platform and enable competitor ad monitoring functionality.

---

## Tasks

### Task 1.1: Add Ad Monitoring Columns
**Source Todo:** `2026-01-28-add-monitor-ads-column.md`
**Priority:** High

Add columns to enable ad monitoring cron workflow:

```sql
-- Add monitor_ads column (enables cron to check this competitor)
ALTER TABLE competitors 
ADD COLUMN monitor_ads BOOLEAN DEFAULT false;

-- Add last_ads_status column (tracks previous state for change detection)
ALTER TABLE competitors
ADD COLUMN last_ads_status BOOLEAN DEFAULT null;

-- Add index for efficient cron queries
CREATE INDEX idx_competitors_monitor_ads 
ON competitors(monitor_ads) 
WHERE monitor_ads = true;
```

**Verification:**
- [ ] SQL executed successfully in Supabase
- [ ] `monitor_ads` column exists with default `false`
- [ ] `last_ads_status` column exists with default `null`
- [ ] Partial index created for query performance
- [ ] Existing competitors unaffected (all have `monitor_ads = false`)

---

### Task 1.2: Platform Field Documentation
**Source Todo:** `2026-01-28-update-database-platform-field.md`
**Priority:** Low

Document the platform field behavior change. The actual node update happens in Wave 3, but we document the expected values here:

**Current State:**
- `platform` field stores Facebook category (e.g., "Software", "Restaurant")

**Target State:**
- `platform` field stores actual platform: `'facebook'` or `'tiktok'`

**Migration for existing data (optional):**
```sql
-- Infer platform from URL for existing entries
UPDATE competitors
SET platform = CASE 
  WHEN url LIKE '%tiktok.com%' THEN 'tiktok'
  ELSE 'facebook'
END
WHERE platform IS NULL OR platform NOT IN ('facebook', 'tiktok');
```

**Verification:**
- [ ] Migration SQL documented
- [ ] Decision made: run migration now or defer

---

## Execution Order

1. Connect to Supabase SQL Editor
2. Run Task 1.1 SQL migration
3. Verify columns exist
4. (Optional) Run Task 1.2 migration for existing data

---

## Rollback Plan

If issues occur:
```sql
-- Revert Task 1.1
DROP INDEX IF EXISTS idx_competitors_monitor_ads;
ALTER TABLE competitors DROP COLUMN IF EXISTS last_ads_status;
ALTER TABLE competitors DROP COLUMN IF EXISTS monitor_ads;
```

---

## Dependencies

- **Requires:** Supabase database access
- **Blocks:** Wave 5 (Ad Monitoring Cron needs these columns)

---

## Success Criteria

- [ ] Both columns added to competitors table
- [ ] Index created for monitor_ads = true queries
- [ ] No impact on existing data
- [ ] Platform field migration decision documented

---

## Related Todos
- `.planning/todos/pending/2026-01-28-add-monitor-ads-column.md`
- `.planning/todos/pending/2026-01-28-update-database-platform-field.md`
