---
phase: 03-voice-message-flow-overhaul
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/page.tsx
autonomous: true

must_haves:
  truths:
    - API calls include error retry logic
    - User sees helpful error messages on failure
    - Failed uploads can be retried
    - Network errors don't crash the app
  artifacts:
    - path: "app/page.tsx"
      provides: "Error handling for voice flow with retry logic"
      contains: "uploadWithRetry.*catch.*sendAudioToN8n"
  key_links:
    - from: "app/page.tsx:sendAudioToN8n"
      to: "Error boundaries"
      via: "try-catch blocks"
      pattern: "catch.*error"
    - from: "app/page.tsx:error states"
      to: "User feedback"
      via: "Error message display"
      pattern: "error.*message"
---

<objective>
Add comprehensive error handling and retry logic for voice messages

Purpose: Handle network failures, timeouts, and edge cases gracefully
Output: Robust voice flow that recovers from errors automatically
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CLAUDE.md
@app/page.tsx
@app/api/voice/route.ts
@.planning/phases/03-voice-message-flow-overhaul/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add retry logic for voice upload</name>
  <files>app/page.tsx</files>
  <action>
Implement automatic retry for voice upload failures:

1. **Create retry wrapper** (add before sendAudioToN8n):
   ```typescript
   const uploadWithRetry = async (
     formData: FormData, 
     retries = 2
   ): Promise<Response> => {
     try {
       const response = await fetch("/api/voice", {
         method: "POST",
         body: formData,
       })
       
       // Retry on 502, 503, 504, 429 (server errors and rate limit)
       if (!response.ok && retries > 0 && [502, 503, 504, 429].includes(response.status)) {
         console.log(`[Voice] Retrying... (${retries} attempts left)`)
         await new Promise(resolve => setTimeout(resolve, 2000)) // 2s backoff
         return uploadWithRetry(formData, retries - 1)
       }
       
       return response
     } catch (error) {
       // Network error - retry if attempts left
       if (retries > 0) {
         console.log(`[Voice] Network error, retrying... (${retries} left)`)
         await new Promise(resolve => setTimeout(resolve, 2000))
         return uploadWithRetry(formData, retries - 1)
       }
       throw error
     }
   }
   ```

2. **Use retry wrapper in sendAudioToN8n** (line 1956):
   - Replace direct fetch call with `const response = await uploadWithRetry(formData, 2)`
   - This gives 3 total attempts (initial + 2 retries)

3. **Update temp message during retries**:
   - On first retry: Update message to "Retrying upload... (attempt 2)"
   - On second retry: Update message to "Retrying upload... (attempt 3)"
   - Use setMessages to update existing temp message content

4. **Handle final failure gracefully**:
   - After 3 failed attempts, show error message
   - Remove temp processing message
   - Add error message to thread: "Failed to send voice message. Please try again."
   - Clear isProcessing and isRecording states
  </action>
  <verify>
Check app/page.tsx:
- uploadWithRetry function exists with exponential backoff
- sendAudioToN8n uses uploadWithRetry
- Temp message updates during retries
- Error message appears after all retries fail
  </verify>
  <done>
Voice upload has automatic retry:
- Network errors trigger 2 retries with 2s delay
- Server errors (502, 503, 504) trigger retries
- User sees "Retrying..." status during retries
- After 3 failures, user sees helpful error message
  </done>
</task>

<task type="auto">
  <name>Add error states and user feedback</name>
  <files>app/page.tsx</files>
  <action>
Improve error messaging and recovery options:

1. **Add error state** (line ~520, with other state declarations):
   ```typescript
   const [voiceError, setVoiceError] = useState<string | null>(null)
   ```

2. **Update sendAudioToN8n error handling** (lines 2038-2046):
   - On error, set specific error messages:
     - Network error: "Network error. Please check your connection and try again."
     - 401 Unauthorized: "Session expired. Please refresh and log in again."
     - 413 Payload Too Large: "Audio file too large. Please record a shorter message."
     - 429 Rate Limit: "Too many requests. Please wait a moment."
     - Other errors: "Failed to send voice message. Please try again."
   - Set voiceError state: `setVoiceError(errorMessage)`
   - Remove temp messages and clear loading states

3. **Display error message in UI**:
   - In messages list, if voiceError is set, show error card:
     ```typescript
     {voiceError && (
       <div className="bg-red-500/10 border border-red-500/20 rounded-lg p-4 mb-4">
         <p className="text-red-500 text-sm">{voiceError}</p>
         <button 
           onClick={() => setVoiceError(null)}
           className="text-red-500 underline text-xs mt-2"
         >
           Dismiss
         </button>
       </div>
     )}
     ```
   - Place this in the messages container (after temp messages, before real messages)

4. **Clear error on new recording**:
   - In handlePushToTalk, when starting new recording:
   - `setVoiceError(null)` to clear previous errors
   - This allows user to retry immediately

5. **Add microphone permission error**:
   - In handlePushToTalk catch block (line 1841-1844):
   - Check if error is NotAllowedError or NotFoundError
   - Show specific message: "Microphone access denied. Please enable in browser settings."
   - Set voiceError state instead of alert()
  </action>
  <verify>
Test error scenarios:
1. Disable network → Record voice → See error message
2. Click "Dismiss" → Error clears
3. Record new voice → Previous error clears
4. Deny microphone permission → See permission error
  </verify>
  <done>
Error handling provides clear feedback:
- Network errors show specific messages
- Permission errors explain how to fix
- User can dismiss errors
- New recordings clear old errors
- No generic "something went wrong" messages
  </done>
</task>

<task type="auto">
  <name>Add timeout handling for stuck processing</name>
  <files>app/page.tsx</files>
  <action>
Handle cases where voice processing gets stuck:

1. **Add processing timeout** (in sendAudioToN8n after 202 response):
   ```typescript
   // Set timeout to detect stuck processing
   const processingTimeout = setTimeout(() => {
     console.log('[Voice] Processing timeout - forcing refresh')
     if (isProcessing) {
       // Force reload conversations to check if message arrived
       if (activeThreadId) {
         loadConversations(activeThreadId)
       }
       setLoading(false)
       setIsProcessing(false)
       setMessages(prev => prev.filter(m => !m.id.startsWith("temp-")))
       
       // Show timeout error
       setVoiceError('Processing timed out. Your message may have been saved - check above.')
     }
   }, 60000) // 60 second timeout
   ```

2. **Clear timeout on success**:
   - In real-time subscription handler (when assistant message arrives):
   - Store timeout ref: `const processingTimeoutRef = useRef<NodeJS.Timeout | null>(null)`
   - Set timeout ref when starting: `processingTimeoutRef.current = processingTimeout`
   - Clear on success: `if (processingTimeoutRef.current) clearTimeout(processingTimeoutRef.current)`

3. **Clean up timeout on unmount**:
   - In useEffect cleanup for real-time subscription:
   - `if (processingTimeoutRef.current) clearTimeout(processingTimeoutRef.current)`

4. **Add visual timeout indicator**:
   - After 30 seconds of processing, update temp message:
   - "Processing is taking longer than usual..."
   - This gives user feedback that system is still working
  </action>
  <verify>
Check app/page.tsx:
- processingTimeoutRef exists
- Timeout set to 60 seconds after upload
- Timeout cleared when message arrives
- Timeout cleaned up on unmount
- Temp message updates after 30 seconds
  </verify>
  <done>
Timeout handling prevents stuck processing:
- After 30s: Message updates to "taking longer..."
- After 60s: Force refresh and clear loading states
- If message was saved, it appears after refresh
- If not, user sees timeout error and can retry
  </done>
</task>

</tasks>

<verification>
Error scenario testing:
1. **Network failure**: Disable network, record voice, observe 3 retry attempts, see error message
2. **Slow processing**: Record voice, observe "taking longer..." after 30s, timeout after 60s
3. **Microphone denied**: Block microphone permission, tap mic, see permission error
4. **Quick recovery**: See error, tap mic again, error clears, new recording works
5. **Session expired**: Clear cookies, record voice, see session error
</verification>

<success_criteria>
Error handling works comprehensively:
- ✅ Network failures retry automatically (3 attempts)
- ✅ User sees retry progress messages
- ✅ Specific error messages for each failure type
- ✅ Microphone permission errors show helpful message
- ✅ Processing timeout (60s) prevents infinite loading
- ✅ User can dismiss errors and retry
- ✅ Errors clear when starting new recording
- ✅ No app crashes from errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-message-flow-overhaul/03-02-SUMMARY.md`
</output>
