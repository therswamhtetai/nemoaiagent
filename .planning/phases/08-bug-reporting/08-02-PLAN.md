---
phase: 08-bug-reporting
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - n8n workflow: Bug Report Intake (new)
  - app/api/bug-report/route.ts
  - app/page.tsx
autonomous: false

must_haves:
  truths:
    - "Bug report submission is handled by the n8n intake workflow (n8n-backed form submission)"
    - "Reports are rate-limited per user with a simple throttle"
    - "Telegram receives the report (photo + caption when present) including user identity + standard context"
    - "Webhook responds with deterministic success/error JSON"
    - "Submitting blocks UI with a loading state; success shows confirmation then returns to Settings"
    - "Failures show a clear error with Retry while preserving the user's inputs"
  artifacts:
    - path: "n8n workflow: Bug Report Intake"
      provides: "Webhook/form submission intake + Telegram forwarding"
      contains: "rate limit|telegram|bug report"
    - path: "app/api/bug-report/route.ts"
      provides: "Server-side proxy to Bug Report Intake webhook"
      contains: "bug-report|webhook"
    - path: "app/page.tsx"
      provides: "Bug report submit handler wired to n8n intake"
      contains: "submitBugReport"
  key_links:
    - from: "Bug Report UI"
      to: "/api/bug-report"
      via: "submitBugReport fetch"
      pattern: "fetch\(\"/api/bug-report\""
    - from: "/api/bug-report"
      to: "n8n intake webhook"
      via: "server-side fetch"
      pattern: "webhook/bug-report|BUG_REPORT_WEBHOOK"
    - from: "n8n webhook"
      to: "Telegram delivery"
      via: "Send Photo/Message nodes"
      pattern: "telegram|sendPhoto|sendMessage"
---

<objective>
Create the Bug Report Intake n8n workflow, wire the frontend submit to it, and verify end-to-end delivery to Telegram.

Purpose: Ensure bug reports submitted from the UI reach the admin with consistent context and rate limiting using an n8n-backed intake.

Output: New n8n workflow that accepts bug report submissions, plus frontend wiring for submission states.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-bug-reporting/08-CONTEXT.md
@CLAUDE.md (n8n workflow patterns, existing credential IDs, database schema)
</context>

<inputs_needed>
- Telegram bot token (for sending messages)
- Admin Telegram destination (your Telegram user ID for DM)
- n8n webhook URL to accept bug reports (choose a stable path like /webhook/bug-report)
</inputs_needed>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n workflow "Bug Report Intake"</name>
  <files>n8n workflow (new)</files>
  <action>
  Create a new n8n workflow that accepts the bug report submission and forwards it to Telegram.

  Workflow requirements:
  - Trigger: Webhook (POST) at a stable path (e.g., /webhook/bug-report)
  - Input parsing:
    - description
    - optional photo (binary)
    - user identity fields
    - context fields (timestamp, app version, screen, device info)
  - Rate limiting:
    - Simple per-user throttle
    - Recommended implementation: use Supabase `user_preferences` with a key like `bug_report_last_submitted_at` to enforce time-based throttle
  - Telegram delivery:
    - Destination: admin DM (Telegram user ID)
    - If photo present: send as photo with caption
    - If no photo: send as text message
    - Caption/message includes:
      - user identity
      - description
      - timestamp
      - app version
      - screen
      - device/browser basics
  - Response contract to frontend:
    - JSON with `success: true` on success
    - JSON with `success: false` and `error_code` (e.g., RATE_LIMITED) on throttles
    - JSON with `success: false` and human-readable message on errors

  Use existing Supabase credential:
  - supabaseApi: "JbItbwVcQiGCLFAC" (NemoAIDatabase)

  Telegram credentials:
  - Use a Telegram bot credential configured from the provided bot token.
  </action>
  <verify>
  - Workflow validates and executes in n8n
  - With photo: Telegram receives photo + caption
  - Without photo: Telegram receives text
  - Rate limit branch returns RATE_LIMITED JSON
  </verify>
  <done>Bug Report Intake workflow reliably forwards reports to Telegram and returns deterministic JSON to frontend.</done>
</task>

<task type="auto">
  <name>Task 2: Implement /api/bug-report proxy to n8n intake</name>
  <files>app/api/bug-report/route.ts</files>
  <action>
  1. Create or update `app/api/bug-report/route.ts` to accept POST FormData from the client.
  2. Forward the request to the Bug Report Intake webhook created in Task 1:
     - Use a single configured webhook URL (env var or constant), defaulting to a stable path like `/webhook/bug-report` on the n8n host.
     - Pass through FormData including optional photo binary and metadata fields.
  3. Return deterministic JSON to the client:
     - success: true on success
     - success: false with `error_code` for rate limiting (match RATE_LIMITED semantics)
     - success: false with message on errors
  4. Ensure the proxy sets appropriate status codes (200 on success, 429 on rate limit, 5xx on upstream failures).
  </action>
  <verify>
  - POST to `/api/bug-report` reaches the n8n webhook (check n8n execution log).
  - Rate limited requests return 429 with `error_code: RATE_LIMITED`.
  </verify>
  <done>/api/bug-report reliably forwards requests to the n8n intake and returns deterministic JSON.</done>
</task>

<task type="auto">
  <name>Task 3: Wire bug report submit to /api/bug-report</name>
  <files>app/page.tsx</files>
  <action>
  1. Implement client submit that POSTs to `/api/bug-report` using FormData.
  2. Payload requirements:
     - description (string)
     - optional photo (single file)
     - user identity (at minimum user_id; include username/email if available)
     - standard context: timestamp, CURRENT_VERSION, current screen identifier, and basic device/browser info (userAgent)
  3. Handle responses:
     - success: true => show success confirmation then return to Settings
     - rate limited => show friendly error (no data loss) + allow retry later
     - error/timeout => show error + Retry
  4. Ensure UI blocks during submit and preserves inputs on error.
  </action>
  <verify>
  - With no photo: submits successfully.
  - With photo: submits successfully.
  - If workflow returns rate limit: UI shows message and preserves content.
  </verify>
  <done>Frontend submits the report to `/api/bug-report` and correctly handles success/error/rate-limit responses.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: End-to-end verification in the NemoAI UI</name>
  <what-built>Bug Report Intake workflow + end-to-end Telegram delivery</what-built>
  <how-to-verify>
  1. Open Settings and confirm "Report a Bug" is directly above "Sign Out".
  2. Open the bug report screen.
  3. Submit description-only report.
     - Expected: loading state, then success confirmation, then return to Settings.
     - Expected: Telegram DM receives the report with identity + context.
  4. Submit a report with a photo.
     - Expected: Telegram DM receives the photo with caption including the report details.
  5. Try sending multiple reports quickly.
     - Expected: rate limit message appears and no data is lost.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or list exactly what failed</resume-signal>
</task>

</tasks>

<verification>
- [ ] Workflow validates and executes in n8n
- [ ] Telegram receives correct format (photo+caption when present)
- [ ] Simple per-user rate limit is enforced
- [ ] Bug report submit shows loading, success confirmation, and returns to Settings
- [ ] Error state shows Retry and preserves inputs
</verification>

<success_criteria>
1. Admin receives actionable Telegram messages that include identity + context.
2. Reports are throttled per user to prevent spam.
3. UI submission flow is resilient with loading, success, and retry states.
</success_criteria>

<output>
After completion, create `.planning/phases/08-bug-reporting/08-02-SUMMARY.md`
</output>
